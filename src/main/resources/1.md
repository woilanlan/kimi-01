
```java
package top.hxll.kimi.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.CollectionUtils;
import top.hxll.kimi.common.exception.PasswordException;
import top.hxll.kimi.common.exception.UserException;
import top.hxll.kimi.dto.*;
import top.hxll.kimi.dto.req.auth.RegisterReq;
import top.hxll.kimi.dto.req.user.PasswordChangeReq;
import top.hxll.kimi.dto.req.user.UserCreateReq;
import top.hxll.kimi.dto.req.user.UserUpdateRequest;
import top.hxll.kimi.entity.*;
import top.hxll.kimi.mapper.*;
import top.hxll.kimi.security.service.UserDetailsImpl;
import top.hxll.kimi.service.UserService;

import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

/**
 * 用户服务实现类
 *
 * @author kimi
 * @since 1.0.0
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements UserService {

    private final UserMapper userMapper;
    private final RoleMapper roleMapper;
    private final UserRoleMapper userRoleMapper;
    private final PasswordEncoder passwordEncoder;

    @Override
    @Transactional
    public User register(RegisterReq registerReq) {
        log.info("Registering new user: {}", registerReq.getUsername());

        // 验证密码是否一致
        if (!registerReq.isPasswordMatch()) {
            throw new PasswordException("两次输入的密码不一致");
        }

        // 一次性查询所有可能冲突的用户信息
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("username", registerReq.getUsername())
                   .or(qw -> qw.eq("email", registerReq.getEmail()))
                   .or(qw -> qw.eq("phone", registerReq.getPhone()));

        List<User> existingUsers = userMapper.selectList(queryWrapper);

        // 检查冲突
        for (User existingUser : existingUsers) {
            if (existingUser.getUsername().equals(registerReq.getUsername())) {
                throw new UserException("用户名已存在");
            }
            if (registerReq.getEmail() != null &&
                registerReq.getEmail().equals(existingUser.getEmail())) {
                throw new UserException("邮箱已存在");
            }
            if (registerReq.getPhone() != null &&
                registerReq.getPhone().equals(existingUser.getPhone())) {
                throw new UserException("手机号已存在");
            }
        }

        // 创建用户实体
        User user = new User();
        user.setUsername(registerReq.getUsername());
        user.setPassword(passwordEncoder.encode(registerReq.getPassword()));
        user.setEmail(registerReq.getEmail());
        user.setPhone(registerReq.getPhone());
        user.setNickname(registerReq.getNickname());
        user.setStatus(1); // 默认启用
        user.setAvatar("/default-avatar.png"); // 默认头像

        // 保存用户
        userMapper.insert(user);

        // 分配默认角色
        String roleCode = registerReq.getRoleCode() != null ? registerReq.getRoleCode() : "user";
        Role role = roleMapper.selectByRoleCode(roleCode);
        if (role != null) {
            UserRole userRole = new UserRole();
            userRole.setUserId(user.getId());
            userRole.setRoleId(role.getId());
            userRole.setCreateBy(user.getId());
            userRoleMapper.insert(userRole);
            log.info("Assigned role {} to user {}", roleCode, user.getUsername());
        }

        log.info("User registered successfully: {}", user.getUsername());
        return user;
    }

    @Override
    @Transactional
    public boolean changePassword(Long userId, PasswordChangeReq passwordChangeReq) {
        log.info("Changing password for user: {}", userId);

        User user = userMapper.selectById(userId);
        if (user == null) {
            throw new UserException("用户不存在");
        }

        // 验证旧密码
        if (!passwordEncoder.matches(passwordChangeReq.getOldPassword(), user.getPassword())) {
            throw new PasswordException("旧密码不正确");
        }

        // 验证新密码是否一致
        if (!passwordChangeReq.isNewPasswordMatch()) {
            throw new PasswordException("两次输入的新密码不一致");
        }

        // 更新密码
        user.setPassword(passwordEncoder.encode(passwordChangeReq.getNewPassword()));
        user.setUpdateTime(LocalDateTime.now());
        user.setUpdateBy(userId);

        int result = userMapper.updateById(user);
        log.info("Password changed successfully for user: {}", userId);
        return result > 0;
    }

    @Override
    @Transactional
    public boolean resetPassword(Long userId, String newPassword) {
        log.info("Resetting password for user: {}", userId);

        User user = userMapper.selectById(userId);
        if (user == null) {
            throw new UserException("用户不存在");
        }

        user.setPassword(passwordEncoder.encode(newPassword));
        user.setUpdateTime(LocalDateTime.now());

        int result = userMapper.updateById(user);
        log.info("Password reset successfully for user: {}", userId);
        return result > 0;
    }

    @Override
    public UserDto getUserWithRolesAndPermissions(Long userId) {
        User user = userMapper.selectById(userId);
        if (user == null) {
            return null;
        }

        return convertToDto(user);
    }

    @Override
    public IPage<UserDto> getUserPage(Page<User> page, String keyword, Integer status) {
        QueryWrapper<User> wrapper = new QueryWrapper<>();

        if (keyword != null && !keyword.trim().isEmpty()) {
            wrapper.like("username", keyword)
                   .or()
                   .like("nickname", keyword)
                   .or()
                   .like("email", keyword);
        }

        if (status != null) {
            wrapper.eq("status", status);
        }

        wrapper.eq("deleted", 0)
               .orderByDesc("create_time");

        IPage<User> userPage = userMapper.selectPage(page, wrapper);
        IPage<UserDto> dtoPage = new Page<>();
        dtoPage.setCurrent(userPage.getCurrent());
        dtoPage.setSize(userPage.getSize());
        dtoPage.setTotal(userPage.getTotal());
        dtoPage.setRecords(userPage.getRecords().stream()
                .map(this::convertToDto)
                .collect(Collectors.toList()));

        return dtoPage;
    }

    @Override
    @Transactional
    public boolean updateUserInfo(Long userId, UserUpdateRequest updateRequest) {
        User user = userMapper.selectById(userId);
        if (user == null) {
            throw new UserException("用户不存在");
        }

        // 更新用户信息
        if (updateRequest.getEmail() != null) {
            user.setEmail(updateRequest.getEmail());
        }
        if (updateRequest.getPhone() != null) {
            user.setPhone(updateRequest.getPhone());
        }
        if (updateRequest.getNickname() != null) {
            user.setNickname(updateRequest.getNickname());
        }
        if (updateRequest.getAvatar() != null) {
            user.setAvatar(updateRequest.getAvatar());
        }
        if (updateRequest.getStatus() != null) {
            user.setStatus(updateRequest.getStatus());
        }

        user.setUpdateTime(LocalDateTime.now());
        user.setUpdateBy(getCurrentUserId());

        int result = userMapper.updateById(user);

        // 更新角色关联
        if (updateRequest.getRoleIds() != null) {
            updateUserRoles(userId, Arrays.asList(updateRequest.getRoleIds()));
        }

        return result > 0;
    }

    @Override
    @Transactional
    public boolean deleteUser(Long userId) {
        User user = userMapper.selectById(userId);
        if (user == null) {
            throw new UserException("用户不存在");
        }

        // 逻辑删除
        user.setDeleted(1);
        user.setUpdateTime(LocalDateTime.now());
        user.setUpdateBy(getCurrentUserId());

        int result = userMapper.updateById(user);

        // 删除用户角色关联
        userRoleMapper.deleteByUserId(userId);

        log.info("User deleted logically: {}", userId);
        return result > 0;
    }

    @Override
    @Transactional
    public boolean updateUserRoles(Long userId, List<Long> roleIds) {
        // 删除原有角色关联
        userRoleMapper.deleteByUserId(userId);

        // 添加新角色关联
        if (!CollectionUtils.isEmpty(roleIds)) {
            List<UserRole> userRoles = roleIds.stream()
                    .distinct()
                    .map(roleId -> {
                        UserRole userRole = new UserRole();
                        userRole.setUserId(userId);
                        userRole.setRoleId(roleId);
                        userRole.setCreateBy(getCurrentUserId());
                        return userRole;
                    })
                    .collect(Collectors.toList());

            if (!userRoles.isEmpty()) {
                userRoleMapper.batchInsert(userRoles);
            }
        }

        log.info("Updated roles for user {}: {}", userId, roleIds);
        return true;
    }

    @Override
    @Transactional
    public boolean deleteUsers(List<Long> userIds) {
        if (userIds == null || userIds.isEmpty()) {
            return true;
        }

        log.info("Batch deleting users: {}", userIds);

        // 批量逻辑删除用户
        List<User> users = userIds.stream()
                .map(userId -> {
                    User user = new User();
                    user.setId(userId);
                    user.setDeleted(1);
                    user.setUpdateTime(LocalDateTime.now());
                    user.setUpdateBy(getCurrentUserId());
                    return user;
                })
                .collect(Collectors.toList());

        // 批量更新用户
        users.forEach(user -> userMapper.updateById(user));

        // 批量删除用户角色关联
        userIds.forEach(userRoleMapper::deleteByUserId);

        log.info("Batch deleted {} users", userIds.size());
        return true;
    }

    @Override
    public User createUser(UserCreateReq createRequest) {
        log.info("Creating user by admin: {}", createRequest.getUsername());

        // 验证密码一致性
        if (!createRequest.isPasswordMatch()) {
            throw new PasswordException("两次输入的密码不一致");
        }

        // 检查用户名是否已存在
        if (userMapper.selectCount(new QueryWrapper<User>().eq("username", createRequest.getUsername())) > 0) {
            throw new UserException("用户名已存在");
        }

        // 创建用户
        User user = new User();
        user.setUsername(createRequest.getUsername());
        user.setPassword(passwordEncoder.encode(createRequest.getPassword()));
        user.setEmail(createRequest.getEmail());
        user.setPhone(createRequest.getPhone());
        user.setNickname(createRequest.getNickname());
        user.setStatus(createRequest.getStatus() != null ? createRequest.getStatus() : 1);
        user.setAvatar("/default-avatar.png");
        user.setCreateBy(getCurrentUserId());
        user.setCreateTime(LocalDateTime.now());

        userMapper.insert(user);

        // 分配角色
        if (createRequest.getRoleIds() != null && createRequest.getRoleIds().length > 0) {
            List<Long> roleIds = Arrays.asList(createRequest.getRoleIds());
            updateUserRoles(user.getId(), roleIds);
        }

        log.info("User created by admin: {}", user.getUsername());
        return user;
    }

    @Override
    @Transactional
    public boolean toggleUserStatus(Long userId, Integer status) {
        User user = userMapper.selectById(userId);
        if (user == null) {
            throw new UserException("用户不存在");
        }

        user.setStatus(status);
        user.setUpdateTime(LocalDateTime.now());
        user.setUpdateBy(getCurrentUserId());

        int result = userMapper.updateById(user);
        log.info("User status changed: {} -> {}", userId, status);
        return result > 0;
    }

    @Override
    public Map<String, Long> getUserStatistics() {
        Map<String, Long> stats = new HashMap<>();

        // 总用户数
        long totalCount = userMapper.selectCount(new QueryWrapper<User>().eq("deleted", 0));
        stats.put("total", totalCount);

        // 启用用户数
        long activeCount = userMapper.selectCount(new QueryWrapper<User>()
                .eq("status", 1).eq("deleted", 0));
        stats.put("active", activeCount);

        // 禁用用户数
        long inactiveCount = userMapper.selectCount(new QueryWrapper<User>()
                .eq("status", 0).eq("deleted", 0));
        stats.put("inactive", inactiveCount);

        return stats;
    }

    /**
     * 获取当前登录用户ID
     */
    private Long getCurrentUserId() {
        try {
            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
            if (authentication != null && authentication.getPrincipal() instanceof UserDetailsImpl) {
                UserDetailsImpl userDetails = (UserDetailsImpl) authentication.getPrincipal();
                return userDetails.getId();
            }
        } catch (Exception e) {
            log.error("Failed to get current user ID", e);
        }
        return null;
    }

    /**
     * 实体转换为DTO
     */
    private UserDto convertToDto(User user) {
        UserDto dto = new UserDto();
        dto.setId(user.getId());
        dto.setUsername(user.getUsername());
        dto.setEmail(user.getEmail());
        dto.setPhone(user.getPhone());
        dto.setNickname(user.getNickname());
        dto.setAvatar(user.getAvatar());
        dto.setStatus(user.getStatus());
        dto.setLastLoginTime(user.getLastLoginTime());
        dto.setLastLoginIp(user.getLastLoginIp());
        dto.setCreateTime(user.getCreateTime());

        // 获取角色和权限信息
        List<Role> roles = roleMapper.selectRolesByUserId(user.getId());
        if (roles != null) {
            dto.setRoles(roles.stream()
                    .map(role -> {
                        RoleDto roleDto = new RoleDto();
                        roleDto.setId(role.getId());
                        roleDto.setRoleName(role.getRoleName());
                        roleDto.setRoleCode(role.getRoleCode());
                        roleDto.setDescription(role.getDescription());
                        return roleDto;
                    })
                    .collect(Collectors.toList()));
        }

        List<String> permissions = userMapper.selectPermissionsByUserId(user.getId());
        dto.setPermissions(permissions);

        return dto;
    }
}
```